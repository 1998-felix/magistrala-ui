<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "organization" }}
	<!doctype html>
	<html lang="en">
		{{ template "header" }}
		<body>
			{{ template "navbar" . }}
			<div class="main-content pt-3">
				<div class="container">
					<div class="row">
						<div class="col-lg-12 mx-auto py-3 org-col mt-5">
							<div class="organization-nav">
								<ul
									class="nav nav-underline col-lg-3 justify-content-between py-3 px-5"
									role="tablist"
								>
									<li class="nav-item">
										<a
											href="#detailsTab"
											class="nav-link active"
											role="tab"
											data-bs-toggle="tab"
											aria-controls="detailsTab"
											aria-selected="true"
										>
											Details
										</a>
									</li>
									<li class="nav-item">
										<a
											href="#membersTab"
											class="nav-link"
											role="tab"
											data-bs-toggle="tab"
											aria-controls="membersTab"
											aria-selected="false"
										>
											Members
										</a>
									</li>
								</ul>
							</div>
							<div class="tab-content mt-4">
								<div
									class="org-tab tab-pane fade show active px-5"
									role="tabpanel"
									id="detailsTab"
									tabindex="0"
								>
									<div class="row mb-3 p-3">
										<div class="col-md-12">
											<p>
												Welcome to the organizations details page. You can
												update your organization details in this page.
											</p>
										</div>
									</div>
									<div class="row mb-3 p-3">
										<h4 class="mb-3">Organization Information</h4>
										<div class="table-responsive">
											<table class="table border-top">
												<tbody>
													<tr>
														<th>Organization Name</th>
														<td
															class="editable"
															contenteditable="false"
															data-field="name"
														>
															{{ .Organization.Name }}
														</td>
														<td>
															<button
																class="edit-btn"
																onclick="editRow('name')"
															>
																<i class="fas fa-pencil-alt"></i>
															</button>
															<div
																class="save-cancel-buttons"
																style="display: none"
															>
																<button
																	class="save-btn"
																	onclick="saveRow('name')"
																>
																	Save
																</button>
																<button
																	class="cancel-btn"
																	onclick="cancelEditRow('name')"
																>
																	Cancel
																</button>
															</div>
														</td>
													</tr>
													<tr>
														<th>Organization Metadata</th>
														<td
															class="editable"
															contenteditable="false"
															data-field="metadata"
														>
															{{ toJSON .Organization.Metadata }}
														</td>
														<td>
															<button
																class="edit-btn"
																onclick="editRow('metadata')"
															>
																<i class="fas fa-pencil-alt"></i>
															</button>
															<div
																class="save-cancel-buttons"
																style="display: none"
															>
																<button
																	class="save-btn"
																	onclick="saveRow('metadata')"
																>
																	Save
																</button>
																<button
																	class="cancel-btn"
																	onclick="cancelEditRow('metadata')"
																>
																	Cancel
																</button>
															</div>
														</td>
													</tr>
													<tr>
														<th>Organization Tags</th>
														<td
															class="editable"
															contenteditable="false"
															data-field="tags"
														>
															{{ toSlice .Organization.Tags }}
														</td>
														<td>
															<button
																class="edit-btn"
																onclick="editRow('tags')"
															>
																<i class="fas fa-pencil-alt"></i>
															</button>
															<div
																class="save-cancel-buttons"
																style="display: none"
															>
																<button
																	class="save-btn"
																	onclick="saveRow('tags')"
																>
																	Save
																</button>
																<button
																	class="cancel-btn"
																	onclick="cancelEditRow('tags')"
																>
																	Cancel
																</button>
															</div>
														</td>
													</tr>

													<tr>
														<th>Organization Alias</th>
														<td
															class="editable"
															contenteditable="false"
															data-field="alias"
														>
															{{ .Organization.Alias }}
														</td>
														<td>
															<button
																class="edit-btn"
																onclick="editRow('alias')"
															>
																<i class="fas fa-pencil-alt"></i>
															</button>
															<div
																class="save-cancel-buttons"
																style="display: none"
															>
																<button
																	class="save-btn"
																	onclick="saveRow('alias')"
																>
																	Save
																</button>
																<button
																	class="cancel-btn"
																	onclick="cancelEditRow('alias')"
																>
																	Cancel
																</button>
															</div>
														</td>
													</tr>
													<tr>
														<th class="text-muted">Created By</th>
														<td>{{ .Organization.CreatedBy }}</td>
														<td></td>
													</tr>
													<tr>
														<th class="text-muted">Created At</th>
														<td>{{ .Organization.CreatedAt }}</td>
														<td></td>
													</tr>
												</tbody>
											</table>
											<div id="error-message" class="text-danger"></div>
										</div>
									</div>
								</div>
								<div
									class="org-tab tab-pane fade show px-5"
									role="tabpanel"
									id="membersTab"
									tabindex="0"
								>
									<div class="row mb-3 p-3">
										<div class="col-md-12">
											<div
												class="row-mb-3 d-flex flex-row justify-content-between mb-3"
											>
												<h2>Organization Members</h2>
												<button
													role="button"
													class="btn body-button"
													onclick="opeMemberModal()"
												>
													<i class="fa-solid fa-plus me-2"></i>
													Add Member
												</button>
											</div>
											<div class="table-responsive table-container">
												{{ template "tableheader" . }}
												<div class="itemsTable">
													<table id="itemsTable" class="table">
														<thead>
															<tr>
																<th scope="col">Name</th>
																<th class="tags-col" scope="col">Tags</th>
																<th class="meta-col" scope="col">Metadata</th>
																<th class="created-col" scope="col">
																	Created At
																</th>
															</tr>
														</thead>
														<tbody>
															{{ range $i, $m := .Members }}
																<tr
																	onclick="location.href='/users/{{ $m.ID }}';"
																	class="clickable-row"
																>
																	<td>{{ $m.Name }}</td>
																	<td class="tags-col">
																		{{ range $j, $tag := $m.Tags }}
																			<span class="badge bg-dark">
																				{{ $tag }}
																			</span>
																		{{ end }}
																	</td>
																	<td class="meta-col">
																		{{ range $k, $v := $m.Metadata }}
																			<span class="badge bg-success">
																				{{ $k }}:
																				{{ $v }}
																			</span>
																		{{ end }}
																	</td>
																	<td class="created-col">
																		{{ $m.CreatedAt }}
																	</td>
																</tr>
															{{ end }}
														</tbody>
													</table>
												</div>
												{{ template "tablefooter" . }}
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Modal -->
				<div
					class="modal fade"
					id="addMemberModal"
					tabindex="-1"
					aria-labelledby="addMemberModalLabel"
					aria-hidden="true"
				>
					<div class="modal-dialog modal-dialog-centered">
						<div class="modal-content">
							<div class="modal-header">
								<h1
									class="modal-title fs-5"
									id="addMemberModalLabel"
									style="font-weight: 600;"
								>
									Add Member
								</h1>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<form
								action="/organizations/{{ .Organization.ID }}/assign"
								method="post"
							>
								<div class="modal-body">
									<div class="mb-3">
										<label for="users" class="form-label">User ID</label>
										<input
											type="text"
											name="userFilter"
											id="userFilterAssign"
											placeholder="Filter by User ID"
											oninput="fetchIndividualEntity(this.value,'users')"
										/>
										<select
											class="form-select"
											name="userID"
											id="users"
											size="5"
											required
										>
											<option disabled>select a User</option>
										</select>
									</div>
									u
									<div class="mb-3">
										<label for="relation" class="form-label">Relation</label>
										<select
											class="form-control"
											name="relation"
											id="relation"
											aria-describedby="relationHelp"
											multiple
											required
										>
											{{ range $r := .Relations }}
												<option value="{{ $r }}">
													{{ $r }}
												</option>
											{{ end }}
										</select>
										<div id="relationHelp" class="form-text">
											Select Relation.
										</div>
									</div>
								</div>
								<div class="modal-footer">
									<button
										type="button"
										class="btn btn-secondary"
										data-bs-dismiss="modal"
									>
										Cancel
									</button>
									<button type="submit" class="btn btn-primary">
										Add Member
									</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
            <script>
                function makeEditable(cell) {
                    cell.setAttribute("contenteditable", "true");
                    cell.dataset.originalContent = cell.innerHTML;
                }
                function makeUneditable(cell) {
                    const originalContent = cell.dataset.originalContent;
                    cell.innerHTML = originalContent;
                    cell.setAttribute("contenteditable", "false");
                }
                function showButtons(editBtn, saveCancelBtn) {
                    editBtn.style.display = "none";
                    saveCancelBtn.style.display = "inline-block";
                }
                function hideButtons(editBtn, saveCancelBtn) {
                    editBtn.style.display = "inline-block";
                    saveCancelBtn.style.display = "none";
                }
                function editRow(field) {
                    const cell = document.querySelector(`td[data-field='${field}']`);
                    const editBtn = cell.parentNode.querySelector(".edit-btn");
                    const saveCancelBtn = cell.parentNode.querySelector(
                        ".save-cancel-buttons"
                    );

                    // Make the row editable
                    makeEditable(cell);

                    // Hide the edit button and show save and cancel buttons
                    showButtons(editBtn, saveCancelBtn);
                }
                function cancelEditRow(field) {
                    const cell = document.querySelector(`td[data-field='${field}']`);
                    const editBtn = cell.parentNode.querySelector(".edit-btn");
                    const saveCancelBtn = cell.parentNode.querySelector(
                        ".save-cancel-buttons"
                    );
                    const errorMessage = document.getElementById("error-message");

                    errorMessage.textContent = "";

                    // Restore original values in the row
                    makeUneditable(cell);

                    // Show the edit button and hide the save and cancel buttons
                    hideButtons(editBtn, saveCancelBtn);
                }
                function saveRow(field) {
                    const cell = document.querySelector(`td[data-field='${field}']`);
                    const editBtn = cell.parentNode.querySelector(".edit-btn");
                    const saveCancelBtn = cell.parentNode.querySelector(
                        ".save-cancel-buttons"
                    );
                    const errorMessage = document.getElementById("error-message");

                    // Get the updated value from the updated Cell
                    const updatedValue = cell.textContent.trim();

                    // Send the updated value to the server using the POST request
                    const url = "/organizations/{{.Organization.ID}}";
                    let data;
                    switch (field) {
                        case "name":
                        case "alias":
                        data = { [field]: updatedValue };
                        break;
                        case "tags":
                        try {
                            const tags = JSON.parse(updatedValue);
                            if (
                            !Array.isArray(tags) ||
                            !tags.every(function (tag) {
                                return typeof tag === "string";
                            })
                            ) {
                            errorMessage.textContent = "Tags must be a string array!";
                            break;
                            }
                            data = { [field]: JSON.parse(updatedValue) };
                        } catch (error) {
                            errorMessage.textContent = "Tags must be a valid string array";
                            break;
                        }
                        break;
                        case "metadata":
                        try {
                            const metadata = JSON.parse(updatedValue);
                            data = { [field]: metadata };
                        } catch (error) {
                            errorMessage.textContent = "Metadata must be a valid JSON object!";
                        }
                        break;
                        default:
                        console.error("invalid field: ", field);
                    }
                    fetch(url, {
                        method: "POST",
                        body: JSON.stringify(data),
                        headers: {
                        "Content-Type": "application/json",
                        },
                    })
                        .then((response) => {
                        if (response.ok) {
                            // Make the row uneditable
                            cell.setAttribute("contenteditable", "false");
                            // Show edit button and hide save and cancel buttons
                            hideButtons(editBtn, saveCancelBtn);
                            errorMessage.textContent = "";
                            if (field === "name") {
                            localStorage.setItem("organizationName", updatedValue);
                            }
                            window.location.reload();
                        } else if (response.status === 409) {
                            errorMessage.textContent =
                            "Organization with the same name already exists";
                        }
                        })
                        .catch((error) => {
                        // Restore original values in the row if there is an error
                        makeUneditable(cell);
                        hideButtons(editBtn, saveCancelBtn);
                        console.error("error updating Organization: ", error);
                        });
                }

				const memberModal = new bootstrap.Modal(
					document.getElementById("addMemberModal"),
				);
				function opeMemberModal() {
					memberModal.show();
					getUser("");
					getAdditionalUsers("");
				}
				function fetchIndividualEntity(filterValue, selectId) {
					const itemSelect = document.getElementById(selectId);
					if (filterValue === "") {
						itemSelect.innerHTML = "<option disabled>select a user</option>";
						getUser("");
						getAdditionalUsers();
					} else {
						itemSelect.innerHTML = "";
						getUser(filterValue);
					}
				}
				let limit = 5;

				function getUser(name) {
					fetchUserData(name, 1);
				}
				function getAdditionalUsers() {
					var selectElement = document.getElementById("users");
					var singleOptionHeight =
						selectElement.querySelector("option").offsetHeight;
					var selectBoxHeight = selectElement.offsetHeight;
					var numOptionsBeforeLoad = 2;
					var lastScrollTop = 0;
					var currentPageNo = 1;
					var currentScroll = 0;

					selectElement.addEventListener("scroll", onselectScroll);

					function onselectScroll(event) {
						var st = selectElement.scrollTop;
						var totalHeight =
							selectElement.querySelectorAll("option").length *
							singleOptionHeight;

						if (st > lastScrollTop) {
							currentScroll = st + selectBoxHeight;
							if (
								currentScroll + numOptionsBeforeLoad * singleOptionHeight >=
								totalHeight
							) {
								currentPageNo++;
								fetchUserData("", currentPageNo);
							}
						}

						lastScrollTop = st;
					}
				}
				function fetchUserData(name, page) {
					fetch(
						`/entities?item=users&limit=${limit}&name=${name}&page=${page}`,
						{
							method: "GET",
						},
					)
						.then((response) => response.json())
						.then((data) => {
							const selectElement = document.getElementById("users");
							data.data.forEach((user) => {
								const option = document.createElement("option");
								option.value = user.id;
								option.text = user.name;
								selectElement.appendChild(option);
							});
						})
						.catch((error) => console.error("Error:", error));
				}
            </script>
		</body>
	</html>
{{ end }}
